# ServalSheets Environment Configuration

# ===========================
# REQUIRED FOR PRODUCTION
# ===========================

# JWT signing secret (generate: openssl rand -hex 32)
# REQUIRED in production mode
JWT_SECRET=your-jwt-secret-here

# OAuth state HMAC secret (generate: openssl rand -hex 32)
# REQUIRED in production mode
STATE_SECRET=your-state-secret-here

# OAuth client secret (generate: openssl rand -hex 32)
# REQUIRED in production mode
OAUTH_CLIENT_SECRET=your-oauth-client-secret-here

# Comma-separated list of allowed OAuth redirect URIs
# REQUIRED in production - prevents open redirect vulnerability
ALLOWED_REDIRECT_URIS=http://localhost:3000/callback,https://your-app.com/callback

# ===========================
# NODE ENVIRONMENT
# ===========================

# Environment mode (development, production, test)
# Set to 'production' for production deployments
NODE_ENV=development

# ===========================
# SERVER CONFIGURATION
# ===========================

# Server port (for HTTP/SSE server)
PORT=3000

# Alternative: HTTP_PORT (used by lifecycle.ts)
HTTP_PORT=3000

# Server host binding (default: 127.0.0.1 for security)
# 127.0.0.1 = localhost only (secure, recommended for development)
# 0.0.0.0 = all network interfaces (use only in production with proper firewall)
HOST=127.0.0.1

# ===========================
# OAUTH CONFIGURATION
# ===========================

# OAuth issuer URL (base URL of your server)
OAUTH_ISSUER=https://servalsheets.example.com

# OAuth client ID
OAUTH_CLIENT_ID=servalsheets

# OAuth token expiration (seconds)
# Access tokens are short-lived JWT tokens for API access
# Refresh tokens are long-lived for obtaining new access tokens
# Default: ACCESS_TOKEN_TTL=3600 (1 hour), REFRESH_TOKEN_TTL=2592000 (30 days)
# ACCESS_TOKEN_TTL=3600
# REFRESH_TOKEN_TTL=2592000

# ===========================
# GOOGLE API CREDENTIALS
# ===========================

# Google OAuth Client ID (for Google Sheets access)
GOOGLE_CLIENT_ID=your-google-client-id.apps.googleusercontent.com

# Google OAuth Client Secret
GOOGLE_CLIENT_SECRET=your-google-client-secret

# ===========================
# TOKEN ENCRYPTION
# ===========================

# Encryption key for token storage (generate: openssl rand -hex 32)
# REQUIRED in production mode for GOOGLE_TOKEN_STORE_PATH
# Must be 64 hex characters (32 bytes)
# ENCRYPTION_KEY=your-encryption-key-here

# ===========================
# CORS CONFIGURATION (HTTP/SSE/Remote modes)
# ===========================

# Comma-separated list of allowed CORS origins
# MEDIUM-005 FIX: Clear documentation for CORS security
#
# IMPORTANT: Configure appropriately for your deployment:
#
# Development (permissive, for local testing):
#   CORS_ORIGINS=http://localhost:3000,http://localhost:3001,http://127.0.0.1:3000
#
# Production (restrictive, whitelist specific origins):
#   CORS_ORIGINS=https://claude.ai,https://claude.com,https://your-app.com
#
# WARNING: Never use '*' (allow all) in production - security vulnerability!
#
# Default: Claude AI domains + localhost for development
CORS_ORIGINS=https://claude.ai,https://claude.com,http://localhost:3000

# ===========================
# SESSION STORAGE (HTTP/SSE/Remote modes)
# ===========================

# Session Store Type (memory | redis)
# CRITICAL FOR PRODUCTION: Use 'redis' for persistent OAuth sessions
#
# memory: Simple, fast, but sessions lost on restart (development only)
# redis: Persistent, distributed, required for:
#   - Production deployments
#   - Load-balanced/multi-instance setups
#   - High availability requirements
#   - OAuth session persistence across restarts
#
# Default: memory (WARNING: not suitable for production)
SESSION_STORE_TYPE=memory

# Redis URL for session storage (REQUIRED when SESSION_STORE_TYPE=redis)
# Format: redis://[username]:[password]@[host]:[port]/[db]
# Examples:
#   - Local: redis://localhost:6379
#   - With auth: redis://:password@localhost:6379
#   - Remote: redis://user:pass@redis.example.com:6379/0
#
# REDIS_URL=redis://localhost:6379

# Maximum sessions per user (default: 5)
# Prevents session exhaustion attacks
# MAX_SESSIONS_PER_USER=5

# Session TTL in seconds (default: 86400 = 24 hours)
# Sessions older than this are automatically cleaned up
# SESSION_TTL_SECONDS=86400

# Log level (debug, info, warn, error)
# LOG_LEVEL=info

# ===========================
# TASK STORAGE (MCP SEP-1686)
# ===========================

# Task Store Backend (auto-detected based on REDIS_URL)
#
# The server automatically selects the task store based on environment:
#   - If REDIS_URL is set: Uses RedisTaskStore (distributed, persistent)
#   - If REDIS_URL is not set: Uses InMemoryTaskStore (single-instance)
#
# InMemoryTaskStore (development):
#   - Simple, fast, low overhead
#   - Task state stored in process memory
#   - Tasks lost on server restart
#   - Suitable for single-instance development
#
# RedisTaskStore (production):
#   - Distributed task state across multiple instances
#   - Tasks persist across server restarts
#   - Required for:
#     * Load-balanced/multi-instance deployments
#     * Horizontal scaling
#     * High availability
#     * Task state sharing between servers
#   - Automatic TTL-based expiration
#   - Real-time task status notifications via pub/sub
#
# IMPORTANT: If you set REDIS_URL, the server will automatically use Redis
# for BOTH session storage AND task storage. No additional configuration needed.
#
# For production with multiple instances, ensure REDIS_URL is set.
# Example: REDIS_URL=redis://localhost:6379
#
# Task Retention:
# - Tasks automatically expire based on their TTL (default: 1 hour)
# - Redis handles cleanup automatically via key expiration
# - No manual cleanup required

# ===========================
# PERFORMANCE TUNING
# ===========================

# Enable response caching (true | false, default: true)
# Set to 'false' to disable (any other value enables)
# CACHE_ENABLED=true

# Maximum cache size in megabytes
# CACHE_MAX_SIZE_MB=100

# Cache entry time-to-live in milliseconds (5 minutes = 300000ms)
# CACHE_TTL_MS=300000

# ===========================
# REQUEST DEDUPLICATION
# ===========================

# Enable request deduplication (true | false, default: true)
# Prevents duplicate identical requests within the timeout window
# Set to 'false' to disable (any other value enables)
# DEDUPLICATION_ENABLED=true

# Deduplication timeout in milliseconds (30 seconds = 30000ms)
# How long to wait before considering a request timed out
# DEDUPLICATION_TIMEOUT=30000

# Maximum pending requests to track (default: 1000)
# DEDUPLICATION_MAX_PENDING=1000

# ===========================
# CONNECTION POOLING
# ===========================

# Maximum number of persistent HTTP connections to Google APIs
# Higher values allow more parallel requests but consume more resources
# Default: 50 (balanced for most workloads)
# GOOGLE_API_MAX_SOCKETS=50

# Keep-alive timeout for persistent connections (milliseconds)
# How long to keep idle connections open for reuse
# Default: 30000 (30 seconds)
# GOOGLE_API_KEEPALIVE_TIMEOUT=30000

# Diff engine concurrent sheet fetches (prevents OOM on large spreadsheets)
# How many sheets to process in parallel when capturing state
# Default: 10 (balanced between speed and memory usage)
# DIFF_ENGINE_CONCURRENCY=10

# ===========================
# RATE LIMITING
# ===========================

# Google Sheets API rate limits (per minute)
# Default: 300 reads/min, 60 writes/min (matches Google's default quotas)
# RATE_LIMIT_READS_PER_MINUTE=300
# RATE_LIMIT_WRITES_PER_MINUTE=60

# ===========================
# CIRCUIT BREAKER
# ===========================

# Circuit breaker failure threshold (number of consecutive failures before opening)
# CIRCUIT_BREAKER_FAILURE_THRESHOLD=5

# Circuit breaker success threshold (successes in half-open before closing)
# CIRCUIT_BREAKER_SUCCESS_THRESHOLD=2

# Circuit breaker timeout (milliseconds to stay open before trying half-open)
# CIRCUIT_BREAKER_TIMEOUT_MS=30000

# ===========================
# TRACING & OBSERVABILITY
# ===========================

# Enable OpenTelemetry tracing (set to 'true' to enable)
# OTEL_ENABLED=false

# Enable OpenTelemetry span logging (set to 'true' to enable)
# Logs spans to console for debugging
# OTEL_LOG_SPANS=false

# Tracing sample rate (0.0 to 1.0) - 0.1 = sample 10% of requests
# TRACING_SAMPLE_RATE=0.1

# ===========================
# SAFETY LIMITS
# ===========================

# Maximum number of concurrent Google API requests
# MAX_CONCURRENT_REQUESTS=10

# Google API call timeout in milliseconds (30 seconds = 30000ms)
# Enforces deadline for individual Google Sheets/Drive API requests
# GOOGLE_API_TIMEOUT_MS=30000

# Request timeout in milliseconds (30 seconds = 30000ms)
# REQUEST_TIMEOUT_MS=30000

# Graceful shutdown timeout in milliseconds (10 seconds = 10000ms)
# GRACEFUL_SHUTDOWN_TIMEOUT_MS=10000

# ===========================
# SECURITY NOTES
# ===========================

# 1. Generate strong secrets:
#    openssl rand -hex 32
#
# 2. Never commit secrets to version control
#
# 3. Rotate secrets regularly (every 90 days recommended)
#
# 4. Keep JWT_SECRET and STATE_SECRET different
#
# 5. In production, ensure NODE_ENV=production
#
# 6. Restrict ALLOWED_REDIRECT_URIS to your actual app URLs
#
# 7. Consider using a secrets manager (AWS Secrets Manager, Vault, etc.)
