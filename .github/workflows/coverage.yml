name: Coverage Tracking

on:
  push:
    branches: [main, feat/*, fix/*]
  pull_request:
    branches: [main]

permissions:
  contents: read

jobs:
  coverage:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Generate coverage summary
        id: coverage
        run: |
          # Extract coverage percentages
          STATEMENTS=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct')
          BRANCHES=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct')
          FUNCTIONS=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct')
          LINES=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')

          echo "statements=$STATEMENTS" >> $GITHUB_OUTPUT
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "functions=$FUNCTIONS" >> $GITHUB_OUTPUT
          echo "lines=$LINES" >> $GITHUB_OUTPUT

          # Create badge color based on coverage
          if (( $(echo "$LINES >= 80" | bc -l) )); then
            COLOR="green"
          elif (( $(echo "$LINES >= 60" | bc -l) )); then
            COLOR="yellow"
          else
            COLOR="red"
          fi
          echo "color=$COLOR" >> $GITHUB_OUTPUT

      - name: Upload coverage reports
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/lcov.info
          flags: unittests
          name: codecov-servalsheets
          fail_ci_if_error: false
          verbose: true
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

      - name: Upload coverage artifacts
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 30

      - name: Comment coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));

            const total = coverage.total;
            const statements = total.statements.pct.toFixed(2);
            const branches = total.branches.pct.toFixed(2);
            const functions = total.functions.pct.toFixed(2);
            const lines = total.lines.pct.toFixed(2);

            const comment = `## üìä Coverage Report

            | Metric | Coverage | Change |
            |--------|----------|--------|
            | **Statements** | ${statements}% | - |
            | **Branches** | ${branches}% | - |
            | **Functions** | ${functions}% | - |
            | **Lines** | ${lines}% | - |

            <details>
            <summary>üìÅ Coverage by File</summary>

            Full coverage report available in [artifacts](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
            </details>

            ---
            *ü§ñ Generated by [Coverage Action](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})*`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Check coverage thresholds
        run: |
          STATEMENTS=$(cat coverage/coverage-summary.json | jq -r '.total.statements.pct')
          BRANCHES=$(cat coverage/coverage-summary.json | jq -r '.total.branches.pct')
          FUNCTIONS=$(cat coverage/coverage-summary.json | jq -r '.total.functions.pct')
          LINES=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')

          echo "Coverage Summary:"
          echo "  Statements: $STATEMENTS%"
          echo "  Branches: $BRANCHES%"
          echo "  Functions: $FUNCTIONS%"
          echo "  Lines: $LINES%"

          # Check if coverage meets minimum thresholds (configurable via vitest.config.ts)
          if (( $(echo "$LINES < 75" | bc -l) )); then
            echo "::warning::Line coverage ($LINES%) is below threshold (75%)"
          fi

          if (( $(echo "$BRANCHES < 70" | bc -l) )); then
            echo "::warning::Branch coverage ($BRANCHES%) is below threshold (70%)"
          fi

      - name: Report status
        run: |
          echo "‚úÖ Coverage report generated successfully"
          echo ""
          echo "Coverage: ${{ steps.coverage.outputs.lines }}%"
          echo "Status: ${{ steps.coverage.outputs.color }}"
