---
title: Standardized OAuth Setup Guide
category: guide
last_updated: 2026-02-03
description: Complete guide to setting up OAuth with full scopes for all ServalSheets features
version: 1.6.0
tags: [oauth, authentication, setup, scopes, google-api]
audience: user
difficulty: beginner
---

# Standardized OAuth Setup Guide

This guide provides the **ONE CORRECT WAY** to set up OAuth for ServalSheets with full access to all features: Sheets, Drive, BigQuery, and Apps Script.

---

## Why This Matters

ServalSheets previously had multiple OAuth configurations scattered across the codebase, leading to:

- ‚ùå Multiple authentication prompts (incremental consent)
- ‚ùå Missing scopes for advanced features (BigQuery, Apps Script)
- ‚ùå Confusing error messages about insufficient permissions
- ‚ùå Inconsistent behavior between STDIO and HTTP modes

**This guide fixes all of that** with a single, standardized OAuth flow.

---

## Quick Setup (10 minutes)

### Step 1: Create Google Cloud Project & OAuth Credentials

1. **Go to Google Cloud Console**: https://console.cloud.google.com

2. **Create a new project** (or select existing):
   - Click "Select a project" ‚Üí "New Project"
   - Project name: `ServalSheets`
   - Click "Create"

3. **Enable Required APIs**:
   - Navigation Menu ‚Üí APIs & Services ‚Üí Library
   - Enable each of these:
     - ‚úÖ Google Sheets API
     - ‚úÖ Google Drive API
     - ‚úÖ BigQuery API
     - ‚úÖ Apps Script API

4. **Configure OAuth Consent Screen**:
   - APIs & Services ‚Üí OAuth consent screen
   - User Type: **External** (for personal use)
   - Click "Create"

   **App Information:**
   - App name: `ServalSheets`
   - User support email: Your email
   - Developer contact email: Your email

   **Scopes:** Click "Add or Remove Scopes", then add:
   - `https://www.googleapis.com/auth/spreadsheets`
   - `https://www.googleapis.com/auth/drive`
   - `https://www.googleapis.com/auth/drive.appdata`
   - `https://www.googleapis.com/auth/bigquery`
   - `https://www.googleapis.com/auth/cloud-platform`
   - `https://www.googleapis.com/auth/script.projects`
   - `https://www.googleapis.com/auth/script.deployments`
   - `https://www.googleapis.com/auth/script.processes`

   **Test Users:** Add your Google account email

   Click "Save and Continue"

5. **Create OAuth Client ID**:
   - APIs & Services ‚Üí Credentials
   - Click "Create Credentials" ‚Üí "OAuth client ID"
   - Application type: **Web application**
   - Name: `ServalSheets Local`

   **Authorized redirect URIs:**
   - Click "Add URI"
   - Add: `http://localhost:3000/callback`
   - Add: `http://127.0.0.1:3000/callback`

   Click "Create"

   **Download Credentials:**
   - Click the download icon (‚¨áÔ∏è) next to your new OAuth client
   - Save as `credentials.json` in your ServalSheets directory

---

### Step 2: Configure ServalSheets

**Option A: Use credentials.json (Recommended)**

```bash
cd /path/to/servalsheets
# credentials.json should already be in this directory

# Run the automated setup
npm run auth
```

The `npm run auth` command will:

1. Find your `credentials.json`
2. Extract the OAuth credentials
3. Update your `.env` file
4. Open your browser for authentication
5. Save your tokens securely

**Option B: Manual .env configuration**

If you prefer to configure manually, create/update `.env`:

```bash
# Google OAuth Credentials (from Google Cloud Console)
OAUTH_CLIENT_ID=YOUR_CLIENT_ID.apps.googleusercontent.com
OAUTH_CLIENT_SECRET=YOUR_CLIENT_SECRET
OAUTH_REDIRECT_URI=http://localhost:3000/callback

# Server Configuration
HTTP_PORT=3000
NODE_ENV=development
LOG_LEVEL=info

# Session & Security (auto-generated by npm run auth)
SESSION_SECRET=$(openssl rand -hex 32)
ENCRYPTION_KEY=$(openssl rand -hex 32)
JWT_SECRET=$(openssl rand -hex 32)
STATE_SECRET=$(openssl rand -hex 32)

# Allowed Redirect URIs
ALLOWED_REDIRECT_URIS=http://localhost:3000/callback,http://127.0.0.1:3000/callback

# OAuth Scope Mode (use 'full' for all features)
OAUTH_SCOPE_MODE=full
```

Then run:

```bash
npm run auth
```

---

### Step 3: Verify Authentication

```bash
# Start the server
npm run start:http

# In another terminal, test authentication
curl http://localhost:3000/health
```

You should see:

```json
{
  "status": "healthy",
  "authenticated": true,
  "scopes": [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive",
    "https://www.googleapis.com/auth/drive.appdata",
    "https://www.googleapis.com/auth/bigquery",
    "https://www.googleapis.com/auth/cloud-platform",
    "https://www.googleapis.com/auth/script.projects",
    "https://www.googleapis.com/auth/script.deployments",
    "https://www.googleapis.com/auth/script.processes"
  ]
}
```

---

## Scope Modes

ServalSheets supports three scope modes (controlled by `OAUTH_SCOPE_MODE` in `.env`):

### Full Access (Recommended) - `OAUTH_SCOPE_MODE=full`

Includes ALL features:

- ‚úÖ Basic spreadsheet operations (read/write)
- ‚úÖ Sharing and collaboration
- ‚úÖ Templates (stored in Drive AppData)
- ‚úÖ BigQuery integration (Connected Sheets)
- ‚úÖ Apps Script automation
- ‚úÖ Comments and version history

**Scopes:**

- `spreadsheets` - Full Sheets access
- `drive` - Full Drive access (required for sharing)
- `drive.appdata` - Template storage
- `bigquery` - BigQuery operations
- `cloud-platform` - BigQuery export
- `script.projects` - Apps Script projects
- `script.deployments` - Apps Script deployments
- `script.processes` - Apps Script execution

### Minimal Access - `OAUTH_SCOPE_MODE=minimal`

Basic spreadsheet operations only:

- ‚úÖ Read/write spreadsheet data
- ‚úÖ Create new spreadsheets
- ‚ùå No sharing capabilities
- ‚ùå No BigQuery integration
- ‚ùå No Apps Script automation
- ‚ùå No templates

**Scopes:**

- `spreadsheets` - Full Sheets access
- `drive.file` - Only files created by ServalSheets

### Read-Only Access - `OAUTH_SCOPE_MODE=readonly`

Analysis and reporting only:

- ‚úÖ Read spreadsheet data
- ‚úÖ Analyze data quality
- ‚úÖ Generate reports
- ‚ùå Cannot modify any data

**Scopes:**

- `spreadsheets.readonly` - Read-only Sheets access
- `drive.readonly` - Read-only Drive access

---

## Troubleshooting

### "Invalid client" error

Your OAuth client ID or secret is incorrect. Check:

1. `.env` file has correct credentials
2. `credentials.json` matches the OAuth client in Google Cloud Console

### "Redirect URI mismatch" error

The redirect URI doesn't match Google Cloud Console. Ensure:

1. Google Cloud Console has `http://localhost:3000/callback`
2. `.env` has `OAUTH_REDIRECT_URI=http://localhost:3000/callback`
3. Both use the same port (3000)

### "Insufficient permissions" error

You're missing required scopes. Solutions:

1. Delete `~/.servalsheets/tokens.encrypted`
2. Run `npm run auth` again
3. When prompted, grant ALL permissions

### "Token expired" error

Your tokens have expired and can't be refreshed:

1. Delete `~/.servalsheets/tokens.encrypted`
2. Run `npm run auth` again
3. Ensure you granted "offline access" permission

### Missing BigQuery/Apps Script features

You authenticated before adding those scopes:

1. Check `OAUTH_SCOPE_MODE=full` in `.env`
2. Delete `~/.servalsheets/tokens.encrypted`
3. Run `npm run auth` again
4. Grant ALL requested permissions

---

## Security Best Practices

### For Development

- ‚úÖ Use `http://localhost:3000/callback` (localhost is secure)
- ‚úÖ Keep `credentials.json` in `.gitignore`
- ‚úÖ Store tokens in `~/.servalsheets/tokens.encrypted`
- ‚úÖ Use strong `SESSION_SECRET` and `JWT_SECRET`

### For Production

- ‚úÖ Use HTTPS redirect URIs only
- ‚úÖ Store secrets in environment variables (not .env file)
- ‚úÖ Use Redis for session storage (set `REDIS_URL`)
- ‚úÖ Enable rate limiting
- ‚úÖ Restrict OAuth client to specific domains

---

## MCP Protocol Compliance

ServalSheets follows the MCP 2025-11-25 protocol specification for OAuth:

1. **PKCE Required**: All authorization flows use Proof Key for Code Exchange (S256)
2. **State Validation**: HMAC-signed state tokens prevent CSRF attacks
3. **Token Rotation**: Refresh tokens are rotated on each use
4. **Secure Storage**: Tokens encrypted at rest with AES-256-GCM
5. **Scope Validation**: Each operation validates required scopes before execution

---

## Next Steps

Once authenticated, you can:

1. **Test basic operations:**

   ```bash
   # List your spreadsheets
   curl -X POST http://localhost:3000/mcp \
     -H "Content-Type: application/json" \
     -d '{"method":"tools/call","params":{"name":"sheets_core","arguments":{"action":"list"}}}'
   ```

2. **Connect to Claude Desktop:**
   - Follow the [Claude Desktop Setup Guide](./CLAUDE_DESKTOP_SETUP.md)

3. **Explore advanced features:**
   - [BigQuery Integration](./sheets_bigquery.md)
   - [Apps Script Automation](./sheets_appsscript.md)
   - [Template Management](./TABLE_MANAGEMENT.md)

---

## Support

- üêõ **Report issues**: https://github.com/anthropics/claude-code/issues
- üìñ **Full documentation**: `docs/guides/`
- üí¨ **Ask questions**: Include your `.env` (with secrets redacted) and error logs

---

**Last Updated**: 2026-02-03
**Version**: 1.6.0
**Protocol**: MCP 2025-11-25
