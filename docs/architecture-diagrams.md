# ServalSheets Architecture Diagrams

> **Version:** 1.2.0  
> **Last Updated:** January 5, 2026

---

## 1. Complete System Overview

```
┌─────────────────────────────────────────────────────────────────────────────────────────┐
│                              ServalSheets v1.6.0                                        │
│                         MCP 2025-11-25 Protocol Compliant                               │
├─────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                         │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌─────────────────┐       │
│  │   Claude    │     │   Claude    │     │   Claude    │     │  Other MCP     │       │
│  │   Desktop   │     │    Code     │     │     API     │     │   Clients      │       │
│  └──────┬──────┘     └──────┬──────┘     └──────┬──────┘     └────────┬────────┘       │
│         │                   │                   │                      │               │
│         └──────────────────┬┴───────────────────┴──────────────────────┘               │
│                            │                                                            │
│                     ┌──────▼──────┐                                                     │
│                     │  Transport  │                                                     │
│                     │ (STDIO/HTTP)│                                                     │
│                     └──────┬──────┘                                                     │
│                            │                                                            │
│  ┌─────────────────────────▼─────────────────────────┐                                 │
│  │              ServalSheetsServer                    │                                 │
│  │  ┌──────────────┬──────────────┬───────────────┐  │                                 │
│  │  │ McpServer    │ TaskStore    │ Capabilities   │  │                                 │
│  │  │ (SDK)        │ (SEP-1686)   │ (2025-11-25)   │  │                                 │
│  │  └──────────────┴──────────────┴───────────────┘  │                                 │
│  └───────────────────────────┬───────────────────────┘                                 │
│                              │                                                          │
│  ┌───────────────────────────▼───────────────────────┐                                 │
│  │              Tool Registration                      │                                │
│  │  ┌──────────────────────────────────────────────┐  │                                │
│  │  │ TOOL_DEFINITIONS (21 tools, 272 actions)     │  │                                │
│  │  │ ├── schemas/*.ts (Zod discriminated unions)  │  │                                │
│  │  │ ├── annotations.ts (64 MCP hints)            │  │                                │
│  │  │ └── schema-compat.ts (SDK compatibility)     │  │                                │
│  │  └──────────────────────────────────────────────┘  │                                │
│  └───────────────────────────┬───────────────────────┘                                 │
│                              │                                                          │
│  ┌───────────────────────────▼───────────────────────┐                                 │
│  │              Handler Layer (Lazy-Loaded)           │                                │
│  │  ┌──────────────────────────────────────────────┐  │                                │
│  │  │ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐    │  │                                │
│  │  │ │Auth │ │Core │ │Data │ │Fmt  │ │Dims │    │  │                                │
│  │  │ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘    │  │                                │
│  │  │ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐    │  │                                │
│  │  │ │Viz  │ │Colab│ │Adv  │ │Txn  │ │Qual │    │  │                                │
│  │  │ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘    │  │                                │
│  │  │ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐ ┌─────┐    │  │                                │
│  │  │ │Hist │ │Conf │ │Anlyz│ │Fix  │ │Comp │    │  │                                │
│  │  │ └─────┘ └─────┘ └─────┘ └─────┘ └─────┘    │  │                                │
│  │  │ ┌─────┐                                     │  │                                │
│  │  │ │Sess │ (16 handlers total)                 │  │                                │
│  │  │ └─────┘                                     │  │                                │
│  │  └──────────────────────────────────────────────┘  │                                │
│  └───────────────────────────┬───────────────────────┘                                 │
│                              │                                                          │
│  ┌───────────────────────────▼───────────────────────┐                                 │
│  │              Core Services                          │                                │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐     │                                │
│  │  │BatchCompiler│ │DiffEngine  │ │PolicyEnfrc │     │                                │
│  │  └────────────┘ └────────────┘ └────────────┘     │                                │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐     │                                │
│  │  │RangeResolvr│ │RateLimiter │ │SnapshotSvc │     │                                │
│  │  └────────────┘ └────────────┘ └────────────┘     │                                │
│  └───────────────────────────┬───────────────────────┘                                 │
│                              │                                                          │
│  ┌───────────────────────────▼───────────────────────┐                                 │
│  │              External APIs                          │                                │
│  │  ┌────────────────┐  ┌────────────────┐           │                                │
│  │  │ Google Sheets  │  │ Google Drive   │           │                                │
│  │  │ API v4         │  │ API v3         │           │                                │
│  │  └────────────────┘  └────────────────┘           │                                │
│  │  ┌────────────────┐  ┌────────────────┐           │                                │
│  │  │ Google OAuth   │  │ Token Store    │           │                                │
│  │  │ 2.1 + PKCE     │  │ (Encrypted)    │           │                                │
│  │  └────────────────┘  └────────────────┘           │                                │
│  └───────────────────────────────────────────────────┘                                 │
│                                                                                         │
└─────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## 2. Request Processing Pipeline

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Request Processing Pipeline                            │
└─────────────────────────────────────────────────────────────────────────────────┘

  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
  │ Receive │───▶│ Parse   │───▶│Validate │───▶│ Route   │───▶│ Execute │
  │ Request │    │ JSON-RPC│    │ Schema  │    │ Handler │    │ Handler │
  └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
       │              │              │              │              │
       ▼              ▼              ▼              ▼              ▼
  ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐    ┌─────────┐
  │ STDIO/  │    │ Method: │    │  Zod    │    │ Handler │    │ Google  │
  │ HTTP    │    │ tools/  │    │ Input   │    │  Map    │    │ Sheets  │
  │ Transport│   │ call    │    │ Schema  │    │ Lookup  │    │ API     │
  └─────────┘    └─────────┘    └─────────┘    └─────────┘    └─────────┘
                                     │              │              │
                                     ▼              ▼              ▼
                                ┌─────────┐    ┌─────────┐    ┌─────────┐
                                │ Discrim │    │  Lazy   │    │ Core    │
                                │ Union   │    │ Loading │    │Services │
                                │ Match   │    │ Proxy   │    │ Chain   │
                                └─────────┘    └─────────┘    └─────────┘
                                                                   │
                                                                   ▼
                      ┌─────────────────────────────────────────────────┐
                      │                                                 │
                      ▼                                                 ▼
                 ┌─────────┐                                      ┌─────────┐
                 │ Success │                                      │ Error   │
                 │ Path    │                                      │ Path    │
                 └────┬────┘                                      └────┬────┘
                      │                                                 │
                      ▼                                                 ▼
                 ┌─────────┐                                      ┌─────────┐
                 │ Build   │                                      │ Build   │
                 │Response │                                      │ Error   │
                 │content[]│                                      │Response │
                 │+struct  │                                      │isError:T│
                 └────┬────┘                                      └────┬────┘
                      │                                                 │
                      └────────────────────┬────────────────────────────┘
                                           │
                                           ▼
                                      ┌─────────┐
                                      │ Return  │
                                      │ JSON-RPC│
                                      │ Response│
                                      └─────────┘
```

---

## 3. Tool Action Distribution

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                      Action Distribution (165 Total)                             │
└─────────────────────────────────────────────────────────────────────────────────┘

  sheets_dimensions ████████████████████████████████████████████ 21 (12.7%)
  sheets_advanced   ██████████████████████████████████████ 19 (11.5%)
  sheets_dimensions████████████████████████████ 14 (8.5%)
  sheets_analyze   ██████████████████████████ 13 (7.9%)
  sheets_data      ████████████████████████ 12 (7.3%)
  sheets_collaborate   ████████████████████ 10 (6.1%)
  sheets_collaborate   ████████████████████ 10 (6.1%)
  sheets_visualize     █████████████████ 9 (5.5%)
  sheets_format     █████████████████ 9 (5.5%)
  sheets_data     █████████████████ 9 (5.5%)
  sheets_format      ████████████████ 8 (4.8%)
  sheets_collaborate    ████████████████ 8 (4.8%)
  sheets_core      ██████████████ 7 (4.2%)
  sheets_core████████████ 6 (3.6%)
  sheets_visualize      ████████████ 6 (3.6%)
  sheets_auth       ████████ 4 (2.4%)

  Legend: █ = 0.5 actions
```

---

## 4. Safety Rails Architecture

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Safety Rails System                                    │
└─────────────────────────────────────────────────────────────────────────────────┘

                              ┌─────────────────┐
                              │  Tool Request   │
                              └────────┬────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │  Parse Safety   │
                              │    Options      │
                              └────────┬────────┘
                                       │
           ┌───────────────────────────┼───────────────────────────┐
           │                           │                           │
           ▼                           ▼                           ▼
    ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
    │   dryRun    │            │ effectScope │            │expectedState│
    │   Mode      │            │   Limits    │            │   Check     │
    └──────┬──────┘            └──────┬──────┘            └──────┬──────┘
           │                          │                          │
           ▼                          ▼                          ▼
    ┌─────────────┐            ┌─────────────┐            ┌─────────────┐
    │ Preview     │            │maxCells:    │            │ Optimistic  │
    │ Changes     │            │  50000      │            │ Locking     │
    │ Only        │            │maxRows:     │            │ Checksum    │
    │             │            │  unlimited  │            │             │
    └──────┬──────┘            └──────┬──────┘            └──────┬──────┘
           │                          │                          │
           └───────────────────────────┼──────────────────────────┘
                                       │
                                       ▼
                              ┌─────────────────┐
                              │ PolicyEnforcer  │
                              │   Evaluate      │
                              └────────┬────────┘
                                       │
                    ┌──────────────────┴──────────────────┐
                    │                                      │
                    ▼                                      ▼
           ┌─────────────────┐                    ┌─────────────────┐
           │     ALLOW       │                    │     DENY        │
           └────────┬────────┘                    └────────┬────────┘
                    │                                      │
                    ▼                                      ▼
           ┌─────────────────┐                    ┌─────────────────┐
           │  autoSnapshot   │                    │  Return Error   │
           │  if enabled     │                    │  + Alternatives │
           └────────┬────────┘                    └─────────────────┘
                    │
                    ▼
           ┌─────────────────┐
           │ Execute with    │
           │ RateLimiter     │
           └────────┬────────┘
                    │
                    ▼
           ┌─────────────────┐
           │ Return with     │
           │ DiffEngine      │
           │ Report          │
           └─────────────────┘
```

---

## 5. Knowledge Resource Loading

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                        Knowledge Resource System                                 │
└─────────────────────────────────────────────────────────────────────────────────┘

  src/knowledge/                          Runtime Registration
  ├── README.md ─────────────────────────▶ knowledge:///README.md
  ├── DELIVERABLES.md ───────────────────▶ knowledge:///DELIVERABLES.md
  │
  ├── api/
  │   ├── charts.md ─────────────────────▶ knowledge:///api/charts.md
  │   ├── pivot-tables.md ───────────────▶ knowledge:///api/pivot-tables.md
  │   ├── conditional-formatting.md ─────▶ knowledge:///api/conditional-formatting.md
  │   ├── data-validation.md ────────────▶ knowledge:///api/data-validation.md
  │   ├── batch-operations.md ───────────▶ knowledge:///api/batch-operations.md
  │   ├── named-ranges.md ───────────────▶ knowledge:///api/named-ranges.md
  │   └── limits/
  │       └── quotas.json ───────────────▶ knowledge:///api/limits/quotas.json
  │
  ├── formulas/
  │   ├── functions-reference.md ────────▶ knowledge:///formulas/functions-reference.md
  │   ├── financial.json ────────────────▶ knowledge:///formulas/financial.json
  │   ├── lookup.json ───────────────────▶ knowledge:///formulas/lookup.json
  │   └── key-formulas.json ─────────────▶ knowledge:///formulas/key-formulas.json
  │
  └── templates/
      └── common-templates.json ─────────▶ knowledge:///templates/common-templates.json

  Loading Flow:
  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐
  │ Server Init  │───▶│ walkDir()    │───▶│ Register     │
  │              │    │ Recursive    │    │ Resources    │
  └──────────────┘    └──────────────┘    └──────────────┘
```

---

## 6. Build System

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                              Build Pipeline                                      │
└─────────────────────────────────────────────────────────────────────────────────┘

                    ┌─────────────────────────────────┐
                    │       npm run build             │
                    └────────────────┬────────────────┘
                                     │
                    ┌────────────────┴────────────────┐
                    │                                  │
                    ▼                                  ▼
           ┌────────────────┐                ┌────────────────┐
           │      tsc       │                │ build:copy-    │
           │   (TypeScript) │                │ assets         │
           └───────┬────────┘                └───────┬────────┘
                   │                                  │
                   ▼                                  ▼
           ┌────────────────┐                ┌────────────────┐
           │ src/**/*.ts    │                │ src/knowledge/ │
           │      →         │                │      →         │
           │ dist/**/*.js   │                │ dist/knowledge/│
           │ dist/**/*.d.ts │                │                │
           └───────┬────────┘                └───────┬────────┘
                   │                                  │
                   └────────────────┬─────────────────┘
                                    │
                                    ▼
                    ┌────────────────────────────────┐
                    │          dist/                 │
                    │  ├── cli.js (entry point)      │
                    │  ├── server.js                 │
                    │  ├── knowledge/ (14 files)     │
                    │  └── **/*.d.ts                 │
                    └────────────────────────────────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
           ┌────────────┐   ┌────────────┐   ┌────────────┐
           │   STDIO    │   │    HTTP    │   │    SSE     │
           │ (default)  │   │  (server)  │   │  (remote)  │
           │ cli.js     │   │http-server │   │remote-server│
           └────────────┘   └────────────┘   └────────────┘
```

---

## 7. Compliance Matrix

```
┌──────────────────────────────────────────────────────────────────────────────────────────┐
│                         MCP 2025-11-25 Compliance Matrix                                  │
├──────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │ SEP-986: Tool Naming                                                      ✅ PASS  ││
│  │ ├── Pattern: /^[A-Za-z0-9._-]{1,128}$/                                             ││
│  │ ├── Convention: snake_case                                                          ││
│  │ └── All 21 tools validated                                                          ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │ Tool Annotations                                                          ✅ PASS  ││
│  │ ├── title: All 16 set                                                              ││
│  │ ├── readOnlyHint: 15 false, 1 true (analysis)                                      ││
│  │ ├── destructiveHint: 3 false, 13 true                                              ││
│  │ ├── idempotentHint: 14 false, 2 true (format, analysis)                            ││
│  │ └── openWorldHint: All 16 true                                                      ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │ Response Structure                                                        ✅ PASS  ││
│  │ ├── content: ContentBlock[] present                                                ││
│  │ ├── structuredContent: object present                                              ││
│  │ └── isError: boolean (true for errors, undefined for success)                      ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │ Schema Requirements                                                       ✅ PASS  ││
│  │ ├── Input: z.object() at root                                                       ││
│  │ ├── Output: z.object() at root                                                      ││
│  │ └── Discriminated unions: action field inside request                              ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                          │
│  ┌─────────────────────────────────────────────────────────────────────────────────────┐│
│  │ Advanced Features                                                         ✅ PASS  ││
│  │ ├── SEP-1686 Task System: TaskStoreAdapter                                         ││
│  │ ├── SEP-1577 Sampling: sampling.ts                                                 ││
│  │ ├── SEP-1036 Elicitation: elicitation.ts                                           ││
│  │ └── SEP-973 Icons: TOOL_ICONS in features                                          ││
│  └─────────────────────────────────────────────────────────────────────────────────────┘│
│                                                                                          │
└──────────────────────────────────────────────────────────────────────────────────────────┘
```

---

*Diagrams verified against source code: January 5, 2026*
