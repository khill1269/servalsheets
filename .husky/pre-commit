#!/bin/bash
set -e

echo "üîç Running pre-commit checks..."

# Get staged TypeScript files
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.ts$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  # Check if handler files were modified
  STAGED_HANDLERS=$(echo "$STAGED_TS_FILES" | tr ' ' '\n' | grep '^src/handlers/' || true)

  if [ -n "$STAGED_HANDLERS" ]; then
    echo "  ‚Üí Checking schema-handler alignment (handler files modified)"
    npm run validate:alignment || { echo "‚ùå Schema-handler alignment check failed"; exit 1; }
  fi

  # Check if schema files were modified
  STAGED_SCHEMAS=$(echo "$STAGED_TS_FILES" | tr ' ' '\n' | grep '^src/schemas/' || true)

  if [ -n "$STAGED_SCHEMAS" ]; then
    echo "  ‚Üí Regenerating metadata (schema files modified)"
    npm run gen:metadata
    echo "  ‚Üí Validating schema-handler alignment"
    npm run validate:alignment || { echo "‚ùå Schema-handler alignment check failed"; exit 1; }
  fi

  # Run checks in parallel for speed
  echo "  ‚Üí Checking metadata drift"
  npm run check:drift &
  PID_DRIFT=$!

  echo "  ‚Üí Checking for placeholders"
  npm run check:placeholders &
  PID_PLACEHOLDER=$!

  echo "  ‚Üí Checking for debug prints"
  npm run check:debug-prints &
  PID_DEBUG=$!

  echo "  ‚Üí Checking for silent fallbacks"
  npm run check:silent-fallbacks &
  PID_SILENT=$!

  # Wait for all background jobs
  wait $PID_DRIFT || { echo "‚ùå Metadata drift check failed"; exit 1; }
  wait $PID_PLACEHOLDER || { echo "‚ùå Placeholder check failed"; exit 1; }
  wait $PID_DEBUG || { echo "‚ùå Debug print check failed"; exit 1; }
  wait $PID_SILENT || { echo "‚ùå Silent fallback check failed"; exit 1; }

  echo "‚úÖ Pre-commit checks passed"
fi

# Check for staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.md$' || true)

if [ -n "$STAGED_MD_FILES" ]; then
  # Check for audit documents
  STAGED_AUDITS=$(echo "$STAGED_MD_FILES" | tr ' ' '\n' | grep -E '_AUDIT\.md$|_ANALYSIS\.md$|_REPORT\.md$' || true)

  if [ -n "$STAGED_AUDITS" ]; then
    echo "  ‚Üí Validating audit document(s)"
    for AUDIT in $STAGED_AUDITS; do
      npm run validate:audit "$AUDIT" || { echo "‚ùå Audit validation failed for $AUDIT"; exit 1; }
    done
  fi

  echo "üìù Running documentation checks..."

  # Lint only the staged markdown files
  echo "  ‚Üí Linting staged markdown files"
  echo "$STAGED_MD_FILES" | xargs npx markdownlint-cli2 || { echo "‚ùå Markdown lint failed"; exit 1; }

  # Validate frontmatter in docs/ markdown files
  STAGED_DOCS_MD=$(echo "$STAGED_MD_FILES" | tr ' ' '\n' | grep '^docs/' || true)
  if [ -n "$STAGED_DOCS_MD" ]; then
    echo "  ‚Üí Validating frontmatter"
    echo "$STAGED_DOCS_MD" | xargs tsx scripts/check-frontmatter.ts || { echo "‚ùå Frontmatter validation failed"; exit 1; }
  fi

  # Verify documentation action counts if README.md or SKILL.md changed
  if echo "$STAGED_MD_FILES" | grep -q "README.md\|docs/guides/SKILL.md"; then
    echo "  ‚Üí Verifying action counts in documentation"

    # Dynamically read expected counts from source of truth
    EXPECTED=$(node -e "const {TOOL_COUNT,ACTION_COUNT}=require('./dist/schemas/action-counts.js');console.log(\`\${TOOL_COUNT} tools, \${ACTION_COUNT} actions\`);")
    EXPECTED_WITH=$(echo "$EXPECTED" | sed 's/, / with /')

    if ! grep -q "$EXPECTED" README.md; then
      echo "‚ùå README.md has incorrect action count. Expected '$EXPECTED' but not found"
      echo "   Source of truth: src/schemas/action-counts.ts"
      exit 1
    fi

    if ! grep -q "$EXPECTED_WITH" docs/guides/SKILL.md; then
      echo "‚ùå SKILL.md has incorrect action count. Expected '$EXPECTED_WITH' but not found"
      echo "   Source of truth: src/schemas/action-counts.ts"
      exit 1
    fi
  fi

  echo "‚úÖ Documentation checks passed"
fi

# Run lint-staged (formats and lints)
npx lint-staged
