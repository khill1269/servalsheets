#!/bin/bash
set -e

echo "üîç Running pre-commit checks..."

# Get staged TypeScript files
STAGED_TS_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.ts$' || true)

if [ -n "$STAGED_TS_FILES" ]; then
  # Run checks in parallel for speed
  echo "  ‚Üí Checking metadata drift"
  npm run check:drift &
  PID_DRIFT=$!

  echo "  ‚Üí Checking for placeholders"
  npm run check:placeholders &
  PID_PLACEHOLDER=$!

  echo "  ‚Üí Checking for debug prints"
  npm run check:debug-prints &
  PID_DEBUG=$!

  # Wait for all background jobs
  wait $PID_DRIFT || { echo "‚ùå Metadata drift check failed"; exit 1; }
  wait $PID_PLACEHOLDER || { echo "‚ùå Placeholder check failed"; exit 1; }
  wait $PID_DEBUG || { echo "‚ùå Debug print check failed"; exit 1; }

  echo "‚úÖ Pre-commit checks passed"
fi

# Check for staged markdown files
STAGED_MD_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.md$' || true)

if [ -n "$STAGED_MD_FILES" ]; then
  echo "üìù Running documentation checks..."

  # Lint only the staged markdown files
  echo "  ‚Üí Linting staged markdown files"
  echo "$STAGED_MD_FILES" | xargs npx markdownlint-cli2 || { echo "‚ùå Markdown lint failed"; exit 1; }

  # Validate frontmatter in docs/ markdown files
  STAGED_DOCS_MD=$(echo "$STAGED_MD_FILES" | tr ' ' '\n' | grep '^docs/' || true)
  if [ -n "$STAGED_DOCS_MD" ]; then
    echo "  ‚Üí Validating frontmatter"
    echo "$STAGED_DOCS_MD" | xargs tsx scripts/check-frontmatter.ts || { echo "‚ùå Frontmatter validation failed"; exit 1; }
  fi

  # Verify documentation action counts if README.md or SKILL.md changed
  if echo "$STAGED_MD_FILES" | grep -q "README.md\|docs/guides/SKILL.md"; then
    echo "  ‚Üí Verifying action counts in documentation"
    if ! grep -q "21 tools, 293 actions" README.md; then
      echo "‚ùå README.md has incorrect action count. Should be '21 tools, 293 actions'"
      exit 1
    fi
    if ! grep -q "21 tools with 293 actions" docs/guides/SKILL.md; then
      echo "‚ùå SKILL.md has incorrect action count. Should be '21 tools with 293 actions'"
      exit 1
    fi
  fi

  echo "‚úÖ Documentation checks passed"
fi

# Run lint-staged (formats and lints)
npx lint-staged
